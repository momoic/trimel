---
title: "body_comp_and_clinpath"
output: html_document
date: "2025-07-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(caret)
library(survival)
library(survminer)
library(dplyr)
library(gtsummary)
library(data.table)
library(ggplot2)
library(clusterGeneration)
library(devtools)
library(ClusterR)
library(nnet)
library(randomForest)
library(e1071)
library(xgboost)
library(mclust)
library(cluster)
library(kernlab)
library(mboost)
```

Clinical features 
```{r}
#insert cleaned data, need to add patient ID to be able to merge and stratify risk
data <- read.csv("C://PhD work//trimel//barcelona_final.csv")[,-1]
#data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Datasets//roswell_final.csv")[,-1]
#data <- read.csv("C://PhD work//Melanoma-ClinPath-Model//Datasets//SEER_curated_5years.csv")[,-1]
#data = read.csv("C://PhD work//trimel//artificial_roswell-EOC.csv")[,-1]

```

```{r}
# stage <- function(i, df){
#   bd <- df$Breslow_Depth[[i]]
#   ulc <- df$Ulceration[[i]]
#   if (bd < 0.8){
#     if (ulc == 0){s <- "IA"}
#     if (ulc == 1){s <- "IB"}
#   }
#   if (bd >= 0.8 & bd <= 1){s <- "IB"}
#   if (bd > 1 & bd <= 2){
#     if (ulc == 0){s <- "IB"}
#     if (ulc == 1){s <- "IIA"}
#   }
#   if (bd > 2 & bd <= 4){
#     if (ulc == 0){s <- "IIA"}
#     if (ulc == 1){s <- "IIB"}
#   }
#   if (bd > 4){
#     if (ulc == 0){s <- "IIB"}
#     if (ulc == 1){s <- "IIC"}
#   }
#   return(s)
# }
# 
# data$Stage <- unlist(lapply(seq_len(nrow(data)), stage, data))
```

model determination
need to do k-fold cross validation here to determine the strongest model
basically need to do this for k=5 or so, and compare performance across all 5 folds for random forest, xgboost, svm, k nearest neighbors, neural networks and glm
```{r}
data_clinpath = data[,-c(19:25)]
set.seed(1)
preProcValues <- preProcess(data_clinpath, method = c("center", "scale"))
data.ml = predict(preProcValues, data_clinpath)

```

```{r}
# gmm_mclust = Mclust(data, G = 25:50)
# summary(gmm_mclust)
# cluster_assign = gmm_mclust$classification
# dist_matrix = dist(data)
# sil_res = silhouette(cluster_assign, dist_matrix)
# summary(sil_res)
```
 
 
```{r}

opt_gmm = Optimal_Clusters_GMM(data.ml, max_clusters = 50, criterion = "BIC",

                              dist_mode = "eucl_dist", seed_mode = "random_subset",

                              km_iter = 10, em_iter = 10, var_floor = 1e-10,

                              plot_data = T)
plot(1:50, opt_gmm)

gmm_diff = list()
for (i in 1:(length(opt_gmm)-3)){
  gmm_diff[i] = abs((opt_gmm[i+3] - opt_gmm[i])/opt_gmm[i])
}

gmm = GMM(data.ml, 14, dist_mode = "eucl_dist", seed_mode = "random_subset", km_iter = 10,
          em_iter = 10, verbose = F)   
pr = predict(gmm, newdata = data.ml)

data$Group <- as.factor(pr)
data.ml$Group = as.factor(pr)
```

```{r}
logrank <- survdiff(Surv(Met_Time, Mets) ~ Group, data = data)
logrank
```


this calc_sig is met free survival
```{r}
calc_sig <- function(i, data){
  
  data$Comparison <- NA
  data$Comparison[data$Group != i] <- "NC"
  data$Comparison[data$Group == i] <- "C"
  if (length(unique(data$Comparison)) > 1){
  logrank <- survdiff(Surv(Met_Time, Mets) ~ Comparison, data = data)
  pval <- logrank$pvalue
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "HR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- "LR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- NA
  }
  if (pval < 0.05){
    sig <- "S"
  }
  if (pval >= 0.05){
  sig <- "NS"
  }
  if (logrank$obs[[1]] == 0){
    z <- 1
  }
    if (logrank$obs[[1]] > 0){
    z <- 0
  }
  row <- data.frame("Risk" = risk, "Significance" = sig, "Cluster" = i, "Z" = z)
  return(row)
  }
}


data2 <- data.table::rbindlist(lapply(1:14, calc_sig, data))
```

```{r}
inTraining = createDataPartition(data.ml$Age, p = 0.8, list = FALSE)
train_data = data.ml[inTraining,]
test_data = data.ml[-inTraining,]

fitControl = trainControl(method = "boot", number = 1)
```


```{r}
#nn_model = train(Group~., data = train_data, method = "nnet",trControl = fitControl, tuneGrid = expand.grid(size = c(1,5,10), decay = c(0,0.001,0.1)))

#forest_model = train(Group~., data = train_data, method = "rf", trControl = fitControl, tuneGrid = expand.grid(.mtry = sqrt(ncol(train_data[,-10]))))
svm_model = train(Group~., data = train_data, method = "lssvmRadial", trControl = fitControl)
#xgb_model = train(Group~., data = train_data, method = "xgbLinear", trControl = fitControl, tuneGrid = expand.grid(nrounds = 300, eta = c(0.01, 0.1, 1), alpha = c(0, 1, 10), lambda = c(0, 1, 10)))
#knn_model = train(Group~., data = train_data, method = "knn", trControl = fitControl, tuneGrid = expand.grid(k = c(5,10,15,20,25,30,35,40,45,50)))

```

```{r}
#nn_pred = predict(nn_model, newdata = test_data)
#forest_pred = predict(forest_model, newdata = test_data)
svm_pred = predict(svm_model, newdata = test_data)
#xgb_pred = predict(xgb_model, newdata = test_data)
#knn_pred = predict(knn_model, newdata = test_data)

#caret::confusionMatrix(as.factor(nn_pred), as.factor(test_data$Group))
#caret::confusionMatrix(as.factor(forest_pred), as.factor(test_data$Group))
caret::confusionMatrix(as.factor(svm_pred), as.factor(test_data$Group))
#caret::confusionMatrix(as.factor(xgb_pred), as.factor(test_data$Group))
#caret::confusionMatrix(as.factor(knn_pred), as.factor(test_data$Group))


```
radial SVM has good performance for roswell melanoma dataset
```{r}

high_risk = subset(data, Group %in% subset(data2, Risk == "HR" & Significance == "S")$Cluster)
low_risk = subset(data, Group %in% subset(data2, Z == 1)$Cluster)
at_risk <- setdiff(data, high_risk)
at_risk <- setdiff(at_risk, low_risk)
at_risk$Risk = "At Risk"
high_risk$Risk = "High Risk"
low_risk$Risk = "Low Risk"
risk_data = rbind(low_risk, at_risk, high_risk)
```

```{r}
fit = survfit(Surv(MSS_Time, MSS) ~ Risk, data = risk_data)
ggsurvplot(fit, risk_data, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```
```{r}
pairwise_survdiff(Surv(MSS_Time, MSS) ~ Risk, data = risk_data, p.adjust.method = "bonferroni")
```


CT features
```{r}
#data <- read.csv("C://PhD work//clin path code//body comp dataset.csv")
weight = read.csv("C://PhD work//clin path code//EOC body comp weight.csv")
```
Weight to BMI
```{r}
comb_data = merge(risk_data, weight, by = "MRN")
comb_data$BMI = comb_data$chemo_start_wgt/comb_data$ht_first_met**2
```

BMI compared to survival categorical
```{r}
for (i in 1:nrow(comb_data)){
    if (comb_data$BMI[[i]] < 18.5) 
      {comb_data$BMI_cat[[i]] = "Underweight"}
    if (comb_data$BMI[[i]] < 25 & comb_data$BMI[[i]]>=18.5) 
      {comb_data$BMI_cat[[i]] = "Healthy Weight"}
    if (comb_data$BMI[[i]] < 30 & comb_data$BMI[[i]]>=25) 
      {comb_data$BMI_cat[[i]] = "Overweight"}
    if (comb_data$BMI[[i]] < 35 & comb_data$BMI[[i]]>=30) 
      {comb_data$BMI_cat[[i]] = "Obesity Class I"}
    if (comb_data$BMI[[i]] < 40 & comb_data$BMI[[i]]>=35) 
     {comb_data$BMI_cat[[i]] = "Obesity Class II"}
    if (comb_data$BMI[[i]]>=40) 
      {comb_data$BMI_cat[[i]] = "Obesity Class III"}
} 

bmi_tab = comb_data %>%
  group_by(BMI_cat) %>%
  summarize(count = n()) 
bmi_tab = bmi_tab[c(4,2,1,5,3,6),]


comb_data$BMI_cat = factor(comb_data$BMI_cat, levels = c("Underweight", "Healthy Weight", "Overweight", "Obesity Class I", "Obesity Class II", "Obesity Class III"))

pairwise_survdiff(Surv(MSS_Time, MSS) ~ BMI_cat, data = comb_data, p.adjust.method = "bonferroni")
fit <- survfit(Surv(MSS_Time, MSS) ~ BMI_cat, data = comb_data)
ggsurvplot(fit, comb_data, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```


```{r}
res.cut <- surv_cutpoint(comb_data, time = "MSS_Time", event = "MSS",
   variables = c("BMI"))
plot(res.cut, "BMI", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(MSS_Time, MSS) ~ BMI, data = res.cat)
logrank
```

```{r}
fit <- survfit(Surv(MSS_Time, MSS) ~ BMI, res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```



CT adipose measurements to indices
```{r}
comb_data$subq_ht <- comb_data$PRE_SUBQ_1 /(comb_data$ht_first_met)^2
comb_data$vat_ht <- comb_data$PRE_VAT_1 / (comb_data$ht_first_met)^2
comb_data$sma_ht <- comb_data$PRE_SMA_1 / (comb_data$ht_first_met)^2
  
glm <- glm(MSS ~ vat_ht + sma_ht + subq_ht, data = comb_data, family = binomial)
summary(glm)
```

```{r}
comb_data$DMAI <- (glm[[1]][[1]] + glm[[1]][[2]]*comb_data$vat_ht + glm[[1]][[3]]*comb_data$sma_ht + glm[[1]][[4]]*comb_data$subq_ht)
```

```{r}
res.cut <- surv_cutpoint(comb_data, time = "MSS_Time", event = "MSS",
   variables = c("DMAI"))

plot(res.cut, "DMAI", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(MSS_Time, MSS) ~ DMAI, data = res.cat)
logrank
```

```{r}
fit <- survfit(Surv(MSS_Time, MSS) ~ DMAI, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```
SMI
```{r}
res.cut = surv_cutpoint(comb_data, time="MSS_Time", event = "MSS", variables = c("sma_ht"))

plot(res.cut, palette = "npg")
```

```{r}
res.cat = surv_categorize(res.cut)
fit = survfit(Surv(MSS_Time, MSS)~ sma_ht, data =res.cat)
ggsurvplot(fit, res.cat, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```


PMI
```{r}
#res.cut = surv_cutpoint(comb_data, time="survtime", event = "survstat", variables = c("PMI"))

#plot(res.cut, palette = "npg")
```

```{r}
#res.cat = surv_categorize(res.cut)
#fit = survfit(Surv(MSS_Time, MSS)~ PMI, data =res.cat)
#ggsurvplot(fit, res.cat, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```

cox for simple body comp
```{r}
res.cox <- coxph(Surv(MSS_Time, MSS) ~ BMI + BMI_cat + sma_ht + DMAI, data =  comb_data)
summary(res.cox)
```


SMD
```{r}
comb_data$SMD <- (comb_data$PRE_SMA_1 / comb_data$PRE_IMA_1)
```

```{r}
res.cut <- surv_cutpoint(comb_data, time = "MSS_Time", event = "MSS",
   variables = c("SMD"))

plot(res.cut, "SMD", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
fit <- survfit(Surv(MSS_Time, MSS) ~ SMD, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(MSS_Time, MSS) ~ SMD, data = res.cat)
logrank
```

```{r}
comb_data$BCHI <- comb_data$SMD * comb_data$DMAI
```

```{r}
res.cut <- surv_cutpoint(comb_data, time = "MSS_Time", event = "MSS",
   variables = c("BCHI"))


cutpoint_plot <- plot(res.cut, "BCHI")
cutpoint_plot
```


```{r}
res.cat <- surv_categorize(res.cut)
fit <- survfit(Surv(MSS_Time, MSS) ~ BCHI, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(MSS_Time, MSS) ~ BCHI, data = res.cat)
logrank
```

```{r}
comb_data$combined_risk = NA
comb_data$combined_risk[comb_data$Risk == "Low Risk"] = "Low"
comb_data$combined_risk[comb_data$Risk == "At Risk" & comb_data$BCHI < res.cut[[1]][[4]][[1]]] = "Med-Low"
comb_data$combined_risk[comb_data$Risk == "High Risk" & comb_data$BCHI < res.cut[[1]][[4]][[1]]] = "High-Low"
comb_data$combined_risk[comb_data$Risk == "At Risk" & comb_data$BCHI >= res.cut[[1]][[4]][[1]]] = "Med-High"
comb_data$combined_risk[comb_data$Risk == "High Risk" & comb_data$BCHI >= res.cut[[1]][[4]][[1]]] = "High-High"


fit = survfit(Surv(MSS_Time, MSS) ~ combined_risk, comb_data)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
pairwise_survdiff(Surv(MSS_Time, MSS) ~ combined_risk, data = comb_data)
```
retrain on clinpath + BCHI, same number of clusters

```{r}
data_retrain = comb_data[,c(2:19, 36)]
set.seed(2)
preProcValues <- preProcess(data_retrain, method = c("center", "scale"))
data_retrain.ml = predict(preProcValues, data_retrain)

```
 
```{r}
# 
# opt_gmm = Optimal_Clusters_GMM(data_retrain.ml, max_clusters = 50, criterion = "BIC",
# 
#                               dist_mode = "eucl_dist", seed_mode = "random_subset",
# 
#                               km_iter = 10, em_iter = 10, var_floor = 1e-10,
# 
#                               plot_data = T)
# plot(1:50, opt_gmm)


gmm = GMM(data_retrain.ml,14, dist_mode = "eucl_dist", seed_mode = "random_subset", km_iter = 10,
          em_iter = 10, verbose = F)   
pr = predict(gmm, newdata = data_retrain.ml)

data_retrain$Group <- as.factor(pr)
data_retrain.ml$Group = as.factor(pr)

data_retrain2 <- data.table::rbindlist(lapply(1:14, calc_sig, data_retrain))
  
```

```{r}

high_risk = subset(data_retrain, Group %in% subset(data_retrain2, Risk == "HR" & Significance == "S")$Cluster)
low_risk = subset(data_retrain, Group %in% subset(data_retrain2, Z == 1)$Cluster)
at_risk <- setdiff(data_retrain, high_risk)
at_risk <- setdiff(at_risk, low_risk)
at_risk$Risk = "At Risk"
high_risk$Risk = "High Risk"
low_risk$Risk = "Low Risk"
risk_data_retrain = rbind(low_risk, at_risk, high_risk)

# risk_data %>%
#   group_by(Risk) %>%
#   summarize(n=n())
# 
# risk_data_retrain %>%
#   group_by(Risk) %>%
#   summarize( n = n())
# 
# risk_data %>%
#   group_by(Mets, Risk) %>%
#   summarize(n=n())
# 
# risk_data_retrain %>%
#   group_by(Mets, Risk) %>%
#   summarize(n=n())
```

```{r}
fit = survfit(Surv(MSS_Time, MSS) ~ Risk, data = risk_data_retrain)
ggsurvplot(fit, risk_data_retrain, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```
```{r}
pairwise_survdiff(Surv(MSS_Time, MSS) ~ Risk, data = risk_data_retrain, p.adjust.method = "BH")
```

