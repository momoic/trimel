---
title: "body_comp_and_clinpath"
output: html_document
date: "2025-07-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(caret)
library(survival)
library(survminer)
library(dplyr)
library(gtsummary)
library(data.table)
library(ggplot2)
library(clusterGeneration)
library(devtools)
library(ClusterR)
library(nnet)
library(randomForest)
library(e1071)
library(xgboost)
library(mclust)
library(cluster)
library(kernlab)
library(mboost)
```

Clinical features 
```{r}
#insert cleaned data, need to add patient ID to be able to merge and stratify risk
#data <- read.csv("C://PhD work//trimel//barcelona_final.csv")[,-1]
data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Datasets//roswell_final.csv")[,-1]
#data <- read.csv("C://PhD work//Melanoma-ClinPath-Model//Datasets//SEER_curated_5years.csv")[,-1]

```

```{r}
# stage <- function(i, df){
#   bd <- df$Breslow_Depth[[i]]
#   ulc <- df$Ulceration[[i]]
#   if (bd < 0.8){
#     if (ulc == 0){s <- "IA"}
#     if (ulc == 1){s <- "IB"}
#   }
#   if (bd >= 0.8 & bd <= 1){s <- "IB"}
#   if (bd > 1 & bd <= 2){
#     if (ulc == 0){s <- "IB"}
#     if (ulc == 1){s <- "IIA"}
#   }
#   if (bd > 2 & bd <= 4){
#     if (ulc == 0){s <- "IIA"}
#     if (ulc == 1){s <- "IIB"}
#   }
#   if (bd > 4){
#     if (ulc == 0){s <- "IIB"}
#     if (ulc == 1){s <- "IIC"}
#   }
#   return(s)
# }
# 
# data$Stage <- unlist(lapply(seq_len(nrow(data)), stage, data))
```

model determination
need to do k-fold cross validation here to determine the strongest model
basically need to do this for k=5 or so, and compare performance across all 5 folds for random forest, xgboost, svm, k nearest neighbors, neural networks and glm
```{r}
set.seed(1)
preProcValues <- preProcess(data, method = c("center", "scale"))
data.ml = predict(preProcValues, data)

```

```{r}
# gmm_mclust = Mclust(data, G = 25:50)
# summary(gmm_mclust)
# cluster_assign = gmm_mclust$classification
# dist_matrix = dist(data)
# sil_res = silhouette(cluster_assign, dist_matrix)
# summary(sil_res)
```
 
 
```{r}

opt_gmm = Optimal_Clusters_GMM(data.ml, max_clusters = 50, criterion = "BIC",

                              dist_mode = "eucl_dist", seed_mode = "random_subset",

                              km_iter = 10, em_iter = 10, var_floor = 1e-10,

                              plot_data = T)
plot(1:50, opt_gmm)


gmm = GMM(data.ml, 12, dist_mode = "eucl_dist", seed_mode = "random_subset", km_iter = 10,
          em_iter = 10, verbose = F)   
pr = predict(gmm, newdata = data.ml)

data$Group <- as.factor(pr)
data.ml$Group = as.factor(pr)
```

```{r}
logrank <- survdiff(Surv(Met_Time, Mets) ~ Group, data = data)
logrank
```



```{r}
calc_sig <- function(i, data){
  
  data$Comparison <- NA
  data$Comparison[data$Group != i] <- "NC"
  data$Comparison[data$Group == i] <- "C"
  if (length(unique(data$Comparison)) > 1){
  logrank <- survdiff(Surv(Met_Time, Mets) ~ Comparison, data = data)
  pval <- logrank$pvalue
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "HR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- "LR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- NA
  }
  if (pval < 0.05){
    sig <- "S"
  }
  if (pval >= 0.05){
  sig <- "NS"
  }
  if (logrank$obs[[1]] == 0){
    z <- 1
  }
    if (logrank$obs[[1]] > 0){
    z <- 0
  }
  row <- data.frame("Risk" = risk, "Significance" = sig, "Cluster" = i, "Z" = z)
  return(row)
  }
}


data2 <- data.table::rbindlist(lapply(1:12, calc_sig, data))
```

```{r}
inTraining = createDataPartition(data.ml$Age, p = 0.8, list = FALSE)
train_data = data.ml[inTraining,]
test_data = data.ml[-inTraining,]

fitControl = trainControl(method = "boot", number = 1)
```


```{r}
nn_model = train(Group~., data = train_data, method = "nnet",trControl = fitControl, tuneGrid = expand.grid(size = c(1,5,10), decay = c(0,0.001,0.1)))

forest_model = train(Group~., data = train_data, method = "rf", trControl = fitControl, tuneGrid = expand.grid(.mtry = sqrt(ncol(train_data[,-10]))))
svm_model = train(Group~., data = train_data, method = "lssvmRadial", trControl = fitControl)
xgb_model = train(Group~., data = train_data, method = "xgbLinear", trControl = fitControl, tuneGrid = expand.grid(nrounds = 300, eta = c(0.01, 0.1, 1), alpha = c(0, 1, 10), lambda = c(0, 1, 10)))
knn_model = train(Group~., data = train_data, method = "knn", trControl = fitControl, tuneGrid = expand.grid(k = c(5,10,15,20,25,30,35,40,45,50)))
glm_model = train(Group~., data = train_data, method = "glm", trControl = fitControl)
glmboost_model = train(Group~., data = train_data, method = "glmboost", trControl = fitControl)

```

```{r}
nn_pred = predict(nn_model, newdata = test_data)
caret::confusionMatrix(as.factor(nn_pred), as.factor(test_data$Group))


```


CT features
```{r}
data <- read.csv("E:\\PhD Research\\PhD work\\EOC-body-comp\\body comp dataset.csv")
weight = read.csv("E:\\PhD Research\\PhD work\\EOC-body-comp\\EOC body comp weight.csv")
```
Weight to BMI
```{r}
data = merge(data, weight, by = "MRN")
data$BMI = data$chemo_start_wgt/data$ht_first_met**2
```

BMI compared to survival categorical
```{r}
for (i in 1:nrow(data)){
    if (data$BMI[[i]] < 18.5) 
      {data$BMI_cat[[i]] = "Underweight"}
    if (data$BMI[[i]] < 25 & data$BMI[[i]]>=18.5) 
      {data$BMI_cat[[i]] = "Healthy Weight"}
    if (data$BMI[[i]] < 30 & data$BMI[[i]]>=25) 
      {data$BMI_cat[[i]] = "Overweight"}
    if (data$BMI[[i]] < 35 & data$BMI[[i]]>=30) 
      {data$BMI_cat[[i]] = "Obesity Class I"}
    if (data$BMI[[i]] < 40 & data$BMI[[i]]>=35) 
     {data$BMI_cat[[i]] = "Obesity Class II"}
    if (data$BMI[[i]]>=40) 
      {data$BMI_cat[[i]] = "Obesity Class III"}
} 

bmi_tab = data %>%
  group_by(BMI_cat) %>%
  summarize(count = n()) 
bmi_tab = bmi_tab[c(4,2,1,5,3,6),]


data$BMI_cat = factor(data$BMI_cat, levels = c("Underweight", "Healthy Weight", "Overweight", "Obesity Class I", "Obesity Class II", "Obesity Class III"))
fit <- survfit(Surv(survtime, survstat) ~ BMI_cat, data)
ggsurvplot(fit, data, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```


```{r}
res.cut <- surv_cutpoint(data, time = "survtime", event = "survstat",
   variables = c("BMI"))
plot(res.cut, "BMI", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(survtime, survstat) ~ BMI, data = res.cat)
logrank
```

```{r}
fit <- survfit(Surv(survtime, survstat) ~ BMI, res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```



CT adipose measurements to indices
```{r}
data$subq_ht <- data$PRE_SUBQ_1 /(data$ht_first_met)^2
data$vat_ht <- data$PRE_VAT_1 / (data$ht_first_met)^2
data$sma_ht <- data$PRE_SMA_1 / (data$ht_first_met)^2
  
glm <- glm(survstat ~ vat_ht + sma_ht + subq_ht, data = data, family = binomial)
summary(glm)
```

```{r}
data$DMAI <- (1.407917 + -0.003635*data$vat_ht + -0.030907*data$sma_ht + 0.003873*data$subq_ht)
```

```{r}
res.cut <- surv_cutpoint(data, time = "survtime", event = "survstat",
   variables = c("DMAI"))

plot(res.cut, "DMAI", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(survtime, survstat) ~ DMAI, data = res.cat)
logrank
```

```{r}
fit <- survfit(Surv(survtime, survstat) ~ DMAI, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```
SMI
```{r}
res.cut = surv_cutpoint(data, time="survtime", event = "survstat", variables = c("pre_smi_1"))

plot(res.cut, palette = "npg")
```

```{r}
res.cat = surv_categorize(res.cut)
fit = survfit(Surv(survtime, survstat)~ pre_smi_1, data =res.cat)
ggsurvplot(fit, res.cat, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```


PMI
```{r}
'''res.cut = surv_cutpoint(data, time="survtime", event = "survstat", variables = c("PMI"))

plot(res.cut, palette = "npg")'''
```

```{r}
'''res.cat = surv_categorize(res.cut)
fit = survfit(Surv(survtime, survstat)~ PMI, data =res.cat)
ggsurvplot(fit, res.cat, risk.table = TRUE, conf.int = FALSE, pval = TRUE)'''
```

cox for simple body comp
```{r}
res.cox <- coxph(Surv(survtime, survstat) ~ BMI + BMI_cat + pre_smi_1 + DMAI, data =  data)
summary(res.cox)
```


SMD
```{r}
data$SMD <- (data$PRE_SMA_1 / data$PRE_IMA_1)
```

```{r}
res.cut <- surv_cutpoint(data, time = "survtime", event = "survstat",
   variables = c("SMD"))

plot(res.cut, "SMD", palette = "npg")
```

```{r}
res.cat <- surv_categorize(res.cut)
fit <- survfit(Surv(survtime, survstat) ~ SMD, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(survtime, survstat) ~ SMD, data = res.cat)
logrank
```

```{r}
data$BCHI <- data$SMD * data$DMAI
```

```{r}
res.cut <- surv_cutpoint(data, time = "survtime", event = "survstat",
   variables = c("BCHI"))

cutpoint_plot <- plot(res.cut, "BCHI")
cutpoint_plot
```


```{r}
res.cat <- surv_categorize(res.cut)
fit <- survfit(Surv(survtime, survstat) ~ BCHI, data = res.cat)
ggsurvplot(fit, risk.table = TRUE, conf.int = FALSE, pval = TRUE)
```

```{r}
res.cat <- surv_categorize(res.cut)
logrank <- survdiff(Surv(survtime, survstat) ~ BCHI, data = res.cat)
logrank
```
